---
phase: 01-project-setup-safety-foundation
plan: 02
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/safety/safety.go
  - internal/safety/safety_test.go
autonomous: true

must_haves:
  truths:
    - "IsPathBlocked rejects /System, /System/Library/Caches, and any subpath of /System"
    - "IsPathBlocked rejects /usr, /usr/bin but allows /usr/local and /usr/local/bin"
    - "IsPathBlocked rejects /bin and /sbin and their subpaths"
    - "IsPathBlocked rejects /private/var/vm, /private/var/vm/swapfile0, /private/var/vm/sleepimage"
    - "IsPathBlocked allows safe paths: ~/Library/Caches, /Library/Caches, /Applications, /tmp"
    - "IsPathBlocked does not false-positive on boundary cases: /SystemVolume, /usrlocal, /sbinaries"
    - "Path traversal attempts like /System/../System/Library are caught after filepath.Clean"
    - "WarnBlocked outputs to stderr in format: SKIP: {path} ({reason})"
  artifacts:
    - path: "internal/safety/safety.go"
      provides: "IsPathBlocked(), WarnBlocked(), pathHasPrefix() functions with hardcoded blocklist"
      exports: ["IsPathBlocked", "WarnBlocked"]
      min_lines: 50
    - path: "internal/safety/safety_test.go"
      provides: "Comprehensive table-driven tests for all blocked, allowed, and edge-case paths"
      contains: "TestIsPathBlocked"
      min_lines: 60
  key_links:
    - from: "internal/safety/safety.go"
      to: "filepath.Clean + filepath.EvalSymlinks"
      via: "Path normalization before blocklist check"
      pattern: "filepath\\.Clean|filepath\\.EvalSymlinks"
    - from: "internal/safety/safety.go"
      to: "hardcoded blocklist"
      via: "sipProtectedPrefixes and swapProtectedPrefixes variables"
      pattern: "sipProtectedPrefixes|swapProtectedPrefixes"
    - from: "internal/safety/safety_test.go"
      to: "internal/safety/safety.go"
      via: "Tests call IsPathBlocked with blocked, allowed, and edge-case paths"
      pattern: "IsPathBlocked"
---

<objective>
Implement the safety layer that prevents the tool from ever touching SIP-protected paths or swap files, using test-driven development.

Purpose: This is the most safety-critical code in the entire project. It must reject all paths under /System, /usr (except /usr/local), /bin, /sbin, and /private/var/vm before any filesystem operation. TDD ensures every edge case is covered with tests written before implementation.
Output: Tested safety package with `IsPathBlocked()` and `WarnBlocked()` functions ready for use by all future scanning/cleaning phases.
</objective>

<execution_context>
@/Users/gregor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gregor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-setup-safety-foundation/01-RESEARCH.md
@.planning/phases/01-project-setup-safety-foundation/01-CONTEXT.md
@.planning/phases/01-project-setup-safety-foundation/01-01-SUMMARY.md
</context>

<feature>
  <name>Safety Layer: Path Blocklist Validation</name>
  <files>
    internal/safety/safety.go
    internal/safety/safety_test.go
  </files>
  <behavior>
    `IsPathBlocked(path string) (blocked bool, reason string)` validates paths against a hardcoded blocklist.

    **Blocked paths (return true):**

    SIP-protected paths (reason: "SIP-protected"):
    - `/System` -> (true, "SIP-protected")
    - `/System/Library/Caches` -> (true, "SIP-protected")
    - `/usr` -> (true, "SIP-protected")
    - `/usr/bin` -> (true, "SIP-protected")
    - `/usr/share` -> (true, "SIP-protected")
    - `/bin` -> (true, "SIP-protected")
    - `/bin/bash` -> (true, "SIP-protected")
    - `/sbin` -> (true, "SIP-protected")
    - `/sbin/mount` -> (true, "SIP-protected")

    Swap/VM paths (reason: "swap/VM file"):
    - `/private/var/vm` -> (true, "swap/VM file")
    - `/private/var/vm/swapfile0` -> (true, "swap/VM file")
    - `/private/var/vm/sleepimage` -> (true, "swap/VM file")

    **Allowed paths (return false, ""):**

    SIP exceptions:
    - `/usr/local` -> (false, "")
    - `/usr/local/bin` -> (false, "")
    - `/usr/local/Cellar` -> (false, "")

    Safe paths:
    - `/Users/test/Library/Caches` -> (false, "")
    - `/Library/Caches` -> (false, "")
    - `/tmp` -> (false, "")
    - `/Applications` -> (false, "")
    - `/private/var/folders` -> (false, "")

    **Edge cases (path boundary, must NOT false-positive):**
    - `/SystemVolume` -> (false, "") — not a subpath of /System
    - `/usrlocal` -> (false, "") — not a subpath of /usr
    - `/sbinaries` -> (false, "") — not a subpath of /sbin
    - `/binary` -> (false, "") — not a subpath of /bin

    **Path traversal (caught by filepath.Clean):**
    - `/System/../System/Library` -> cleans to `/System/Library` -> (true, "SIP-protected")
    - `/usr/local/../../usr/bin` -> cleans to `/usr/bin` -> (true, "SIP-protected")

    **Symlink resolution (caught by filepath.EvalSymlinks):**
    - Symlinks to protected paths are caught after resolution
    - Resolution failure on existing path -> (true, "cannot resolve path: ...")
    - Resolution failure on non-existent path -> check literal cleaned path

    `WarnBlocked(path, reason string)` prints to stderr:
    - `WarnBlocked("/System", "SIP-protected")` -> stderr: `SKIP: /System (SIP-protected)`

    `pathHasPrefix(path, prefix string) bool` is unexported helper:
    - Checks path == prefix OR strings.HasPrefix(path, prefix+"/")
    - `/System/Library` has prefix `/System` -> true
    - `/SystemVolume` has prefix `/System` -> false
  </behavior>
  <implementation>
    **RED phase:** Create `internal/safety/safety_test.go` with table-driven `TestIsPathBlocked` covering ALL cases listed in behavior above. Also add `TestWarnBlocked` verifying stderr output format. Run `go test ./internal/safety/` — all tests MUST fail (package doesn't exist yet).

    **GREEN phase:** Create `internal/safety/safety.go` implementing:

    1. Package-level variables for blocklists:
       - `sipProtectedPrefixes`: `/System`, `/usr`, `/bin`, `/sbin`
       - `sipExceptions`: `/usr/local`
       - `swapProtectedPrefixes`: `/private/var/vm`

    2. `IsPathBlocked(path string) (bool, string)`:
       - `filepath.Clean(path)` to normalize
       - `filepath.EvalSymlinks(cleaned)` to resolve symlinks
         - If error and `os.IsNotExist(err)`: use cleaned path (non-existent path isn't blocked by our rules)
         - If error and path exists: return `(true, "cannot resolve path: ...")` for safety
       - Clean the resolved path again
       - Check swap prefixes first (no exceptions, simplest check)
       - Check SIP prefixes, but skip if path falls under a SIP exception
       - Return `(false, "")` if no match

    3. `pathHasPrefix(path, prefix string) bool`:
       - `path == prefix || strings.HasPrefix(path, prefix + string(filepath.Separator))`

    4. `WarnBlocked(path, reason string)`:
       - `fmt.Fprintf(os.Stderr, "SKIP: %s (%s)\n", path, reason)`

    Run `go test ./internal/safety/` — all tests MUST pass.

    **REFACTOR phase (if needed):** Clean up, ensure exported function documentation is clear. Run tests again.

    IMPORTANT per user decisions:
    - Core protections are HARDCODED — no config can override them
    - Warning format is exactly: `SKIP: {path} ({reason})`
    - Output to stderr only
  </implementation>
</feature>

<verification>
1. `go test ./internal/safety/ -v` — all tests pass
2. `go test ./internal/safety/ -count=1 -run TestIsPathBlocked` — specifically tests the path blocking logic
3. `go vet ./...` — no issues
4. `go build -o mac-cleaner .` — project still compiles with safety package added
5. Manual review: no test uses `t.Skip()` or hardcoded pass
</verification>

<success_criteria>
All table-driven tests pass covering: SIP-protected paths (blocked), swap/VM paths (blocked), SIP exceptions like /usr/local (allowed), safe paths (allowed), path boundary edge cases (not false-positive), and path traversal attempts (caught). `WarnBlocked` outputs to stderr in the correct format. The safety package compiles cleanly and `go vet` reports no issues.
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup-safety-foundation/01-02-SUMMARY.md`
</output>
