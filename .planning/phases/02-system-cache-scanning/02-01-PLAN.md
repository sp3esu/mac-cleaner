---
phase: 02-system-cache-scanning
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/scan/types.go
  - internal/scan/size.go
  - internal/scan/size_test.go
autonomous: true

must_haves:
  truths:
    - "DirSize returns correct byte count for a directory tree with nested files"
    - "DirSize skips symlinks and permission-denied entries without error"
    - "FormatSize formats bytes as SI units matching macOS convention (kB, MB, GB)"
    - "ScanEntry, CategoryResult, and ScanSummary types exist and are usable by other packages"
  artifacts:
    - path: "internal/scan/types.go"
      provides: "ScanEntry, CategoryResult, ScanSummary type definitions"
      contains: "type ScanEntry struct"
    - path: "internal/scan/size.go"
      provides: "DirSize and FormatSize functions"
      exports: ["DirSize", "FormatSize"]
    - path: "internal/scan/size_test.go"
      provides: "Table-driven tests for DirSize and FormatSize"
      min_lines: 80
  key_links:
    - from: "internal/scan/size.go"
      to: "internal/scan/types.go"
      via: "same package, types used in function signatures"
      pattern: "package scan"
---

<objective>
Create the shared scan result types and size utility functions that all future scanners depend on.

Purpose: Every scanning phase (system caches, browser data, developer caches) needs shared result types and size calculation utilities. Getting these types right in Phase 2 prevents costly refactors later. DirSize and FormatSize have clear input/output contracts making them ideal TDD candidates.

Output: `internal/scan/` package with types.go (ScanEntry, CategoryResult, ScanSummary), size.go (DirSize, FormatSize), and comprehensive tests.
</objective>

<execution_context>
@/Users/gregor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gregor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-system-cache-scanning/02-RESEARCH.md
@.planning/phases/01-project-setup-safety-foundation/01-02-SUMMARY.md
</context>

<feature>
  <name>Core scan types and size utilities</name>
  <files>internal/scan/types.go, internal/scan/size.go, internal/scan/size_test.go</files>
  <behavior>
    **types.go** defines three structs used throughout the project:

    - `ScanEntry` — single scannable item: Path (string), Description (string), Size (int64 bytes)
    - `CategoryResult` — groups entries under a category: Category (string identifier like "system-caches"), Description (string like "User App Caches"), Entries ([]ScanEntry), TotalSize (int64)
    - `ScanSummary` — aggregates all categories: Categories ([]CategoryResult), TotalSize (int64)

    **DirSize(root string) (int64, error):**

    - Empty directory -> 0
    - Directory with one 1024-byte file -> 1024
    - Directory with nested subdirectories containing files -> sum of all file sizes
    - Directory with symlink to file -> symlink NOT counted (only regular files)
    - Non-existent directory -> 0, error
    - Permission-denied entries -> skipped silently, remaining entries still counted
    - Uses `filepath.WalkDir` (not `filepath.Walk`), counts only `d.Type().IsRegular()` entries

    **FormatSize(b int64) string:**

    Uses SI units (base 1000) to match macOS Finder and `du -h`:

    - 0 -> "0 B"
    - 999 -> "999 B"
    - 1000 -> "1.0 kB"
    - 1500 -> "1.5 kB"
    - 1000000 -> "1.0 MB"
    - 1500000 -> "1.5 MB"
    - 1000000000 -> "1.0 GB"
    - 5368709120 -> "5.4 GB"
    - 1000000000000 -> "1.0 TB"
  </behavior>
  <implementation>
    **types.go:**
    - Package `scan` in `internal/scan/`
    - Three exported struct types with godoc comments
    - Size fields are `int64` (bytes) — formatting is a presentation concern
    - Category is a plain string, not an enum (simple, extensible)

    **size.go:**
    - `DirSize(root string) (int64, error)` uses `filepath.WalkDir`
    - WalkDir callback: skip errors (return nil, don't abort), only count `d.Type().IsRegular()` entries, call `d.Info()` to get size
    - Do NOT follow symlinks (WalkDir default behavior)
    - `FormatSize(b int64) string` uses SI units (const unit = 1000)
    - Units: B, kB, MB, GB, TB, PB, EB
    - Format: "%d B" for < 1000, "%.1f %cB" for >= 1000
    - Import `fmt`, `io/fs`, `path/filepath`

    **size_test.go:**
    - Table-driven tests for FormatSize covering all unit boundaries
    - TestDirSize with t.TempDir() creating known file structures
    - TestDirSizeSkipsSymlinks creating a symlink in temp dir, verifying it's not counted
    - TestDirSizeNonExistent verifying error for missing directory
    - TestDirSizeEmptyDir verifying 0 for empty directory
    - Follow established test patterns from internal/safety/safety_test.go (table-driven, descriptive names)
  </implementation>
</feature>

<verification>
```bash
cd /Users/gregor/projects/mac-clarner && go test ./internal/scan/ -v -count=1
cd /Users/gregor/projects/mac-clarner && go vet ./internal/scan/
```

All tests pass. `go vet` clean. Types importable from other packages.
</verification>

<success_criteria>
- All FormatSize test cases pass with exact expected output strings
- DirSize correctly sums file sizes in nested directory structures
- DirSize returns 0 for empty directories
- DirSize skips symlinks (does not count their target size)
- DirSize handles non-existent paths with error (not panic)
- Types compile and are importable by `pkg/system/` package
</success_criteria>

<output>
After completion, create `.planning/phases/02-system-cache-scanning/02-01-SUMMARY.md`
</output>
