---
phase: 02-system-cache-scanning
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - pkg/system/scanner.go
  - pkg/system/scanner_test.go
  - cmd/root.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "User can run mac-cleaner --system-caches --dry-run and see list of cache directories with sizes"
    - "User sees summary showing total space reclaimable from system caches"
    - "Scan covers ~/Library/Caches, ~/Library/Logs, and QuickLook thumbnails"
    - "No files are deleted in any mode (scan is read-only in Phase 2)"
    - "Blocked paths are skipped with stderr warnings via safety.IsPathBlocked"
  artifacts:
    - path: "pkg/system/scanner.go"
      provides: "Scan() function returning []scan.CategoryResult for system caches"
      exports: ["Scan"]
      contains: "func Scan"
    - path: "pkg/system/scanner_test.go"
      provides: "Tests for system scanner with temp directories"
      min_lines: 60
    - path: "cmd/root.go"
      provides: "--system-caches and --dry-run flags, scan execution, formatted output"
      contains: "flagDryRun"
  key_links:
    - from: "pkg/system/scanner.go"
      to: "internal/scan/types.go"
      via: "import and return types"
      pattern: "scan\\.CategoryResult"
    - from: "pkg/system/scanner.go"
      to: "internal/safety/safety.go"
      via: "safety.IsPathBlocked gate before scanning"
      pattern: "safety\\.IsPathBlocked"
    - from: "pkg/system/scanner.go"
      to: "internal/scan/size.go"
      via: "scan.DirSize for size calculation"
      pattern: "scan\\.DirSize"
    - from: "cmd/root.go"
      to: "pkg/system/scanner.go"
      via: "system.Scan() call when --system-caches flag set"
      pattern: "system\\.Scan"
---

<objective>
Build the system cache scanner and wire it to the CLI so `mac-cleaner --system-caches` displays a formatted table of cache directories with sizes and a total.

Purpose: This is the first user-visible scanning feature. It proves the scanning architecture works end-to-end (CLI flag -> scanner -> types -> formatted output) and establishes patterns for all future category scanners in Phase 3+.

Output: Working `mac-cleaner --system-caches --dry-run` command that scans ~/Library/Caches, ~/Library/Logs, and QuickLook thumbnails, displaying results as a formatted table with color.
</objective>

<execution_context>
@/Users/gregor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gregor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-system-cache-scanning/02-RESEARCH.md
@.planning/phases/02-system-cache-scanning/02-01-SUMMARY.md
@internal/safety/safety.go
@cmd/root.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: System cache scanner with fatih/color dependency</name>
  <files>pkg/system/scanner.go, pkg/system/scanner_test.go, go.mod, go.sum</files>
  <action>
    First, add the fatih/color dependency:
    ```
    go get github.com/fatih/color@latest
    ```
    (fatih/color is needed for output formatting in Task 2, but adding it here keeps go.mod changes in one task.)

    Remove `pkg/system/.gitkeep` (no longer needed — real code replaces it).

    Create `pkg/system/scanner.go`:

    Package `system` with import of `internal/scan` and `internal/safety`.

    **Scan() ([]scan.CategoryResult, error):**
    - Resolve home directory with `os.UserHomeDir()`
    - Scan three locations, collecting results into `[]scan.CategoryResult`:
      1. `scanTopLevel(home + "/Library/Caches", "system-caches", "User App Caches")`
      2. `scanTopLevel(home + "/Library/Logs", "system-logs", "User Logs")`
      3. QuickLook: call `quickLookCacheDir()`, if successful call `scanQuickLook()`
    - If a location doesn't exist or fails, skip it (don't error the whole scan)
    - Return all successfully scanned categories

    **scanTopLevel(dir, category, description string) (*scan.CategoryResult, error):**
    - Call `safety.IsPathBlocked(dir)` — if blocked, call `safety.WarnBlocked` and return nil, error
    - Call `os.ReadDir(dir)` — if error (e.g., doesn't exist), return nil, error
    - For each entry in the directory:
      - Build full path: `filepath.Join(dir, entry.Name())`
      - Call `safety.IsPathBlocked(entryPath)` — if blocked, warn and skip
      - Calculate size: if `entry.IsDir()` use `scan.DirSize(entryPath)`, else use `entry.Info().Size()` for regular files
      - Skip entries with 0 bytes (per research recommendation: hide noise)
      - Append `scan.ScanEntry{Path: entryPath, Description: entry.Name(), Size: size}`
    - Sort entries by size descending (largest first, per research recommendation)
    - Calculate TotalSize as sum of entry sizes
    - Return the CategoryResult

    **quickLookCacheDir() (string, error):**
    - Get `$TMPDIR` from `os.Getenv("TMPDIR")`
    - If empty or doesn't contain "/var/folders/", return error
    - Derive cache dir: `filepath.Dir(filepath.Clean(tmpDir))` then `filepath.Join(parent, "C")`
    - Look for ALL `com.apple.quicklook.*` entries under that cache dir (not just ThumbnailsAgent)
    - Return the parent cache dir path
    - If `os.Stat` fails, return error (QuickLook cache may not exist)

    **scanQuickLook(cacheParent, category, description string) (*scan.CategoryResult, error):**
    - Read entries from cacheParent directory
    - Filter only entries matching `com.apple.quicklook.*` prefix
    - For each matching entry, calculate size with `scan.DirSize`
    - Skip 0-byte entries
    - Aggregate into a single CategoryResult with category "quicklook" and description "QuickLook Thumbnails"
    - Sort by size descending

    Create `pkg/system/scanner_test.go`:

    - **TestScanTopLevel:** Create t.TempDir() with 2 subdirectories, each containing files of known sizes. Call scanTopLevel. Assert: correct entry count, correct total size, entries sorted by size descending.
    - **TestScanTopLevelSkipsZeroBytes:** Create t.TempDir() with one empty subdirectory. Assert: entry not included in results.
    - **TestScanTopLevelNonExistent:** Call scanTopLevel on non-existent path. Assert: returns nil, non-nil error.
    - **TestScanTopLevelHandlesFiles:** Create t.TempDir() with a mix of files and directories at top level. Assert: both are sized correctly.
    - **TestScanPreservesFiles:** Create t.TempDir() with files, run scan, verify all files still exist afterward (dry-run safety).
    - Export scanTopLevel for testing by using the same package (not _test package).
  </action>
  <verify>
    ```bash
    cd /Users/gregor/projects/mac-clarner && go test ./pkg/system/ -v -count=1
    cd /Users/gregor/projects/mac-clarner && go vet ./pkg/system/
    ```
    All tests pass. go vet clean.
  </verify>
  <done>
    - scanTopLevel correctly enumerates directory entries, calculates sizes, sorts by size descending, and skips 0-byte entries
    - Safety layer integration works (blocked paths are skipped with warnings)
    - QuickLook cache discovery works via $TMPDIR (or gracefully skips if unavailable)
    - Scan never modifies any files (verified by test)
    - fatih/color added to go.mod
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI flag wiring and formatted output</name>
  <files>cmd/root.go</files>
  <action>
    Update `cmd/root.go` to add --system-caches and --dry-run flags, scan execution, and formatted output.

    **Flag variables (package level):**
    ```go
    var (
        flagDryRun       bool
        flagSystemCaches bool
    )
    ```

    **init() additions:**
    - `rootCmd.PersistentFlags().BoolVar(&flagDryRun, "dry-run", false, "preview what would be removed without deleting")`
    - `rootCmd.Flags().BoolVar(&flagSystemCaches, "system-caches", false, "scan user app caches, logs, and QuickLook thumbnails")`

    **Update rootCmd.Run:**
    - If `flagSystemCaches` is set, call `runSystemCachesScan(cmd)`
    - Otherwise, fall through to `cmd.Help()` (existing behavior)

    **runSystemCachesScan(cmd *cobra.Command):**
    - Call `system.Scan()`
    - If error, print to stderr and return
    - Call `printResults(results, flagDryRun)`

    **printResults(results []scan.CategoryResult, dryRun bool):**
    - Use `text/tabwriter` for column alignment
    - Use `fatih/color` for colored output:
      - Category headers: bold (e.g., `color.New(color.Bold)`)
      - Size values: cyan
      - Total line: green + bold

    Output format (per research, terse, aligned):
    ```
    System Caches (dry run)

      User App Caches    ~/Library/Caches
        com.apple.Safari           245.3 MB
        com.google.Chrome          189.7 MB
        ... (N more items)

      User Logs           ~/Library/Logs
        DiagnosticReports           12.4 MB
        ...

      QuickLook Thumbnails
        ThumbnailsAgent            300.0 kB

      Total: 5.9 GB reclaimable
    ```

    Implementation details:
    - Print "(dry run)" in header if `flagDryRun` is true. If not dry run, still show same output (Phase 2 is scan-only anyway).
    - Show base directory path next to category header (e.g., "~/Library/Caches"). Use `~` shorthand by replacing home dir prefix in display.
    - For each category, list entries sorted by size (already sorted by scanner).
    - After all categories, print total summary line.
    - If no results (all categories empty/missing), print "No system caches found."
    - Use `scan.FormatSize()` for all size formatting.
    - Import `github.com/fatih/color`, `text/tabwriter`, `github.com/gregor/mac-cleaner/pkg/system`, `github.com/gregor/mac-cleaner/internal/scan`
  </action>
  <verify>
    ```bash
    cd /Users/gregor/projects/mac-clarner && go build -o /dev/null .
    cd /Users/gregor/projects/mac-clarner && go run . --system-caches --dry-run
    cd /Users/gregor/projects/mac-clarner && go run . --help
    ```
    Binary compiles. `--system-caches --dry-run` shows formatted output with categories and sizes. `--help` shows the new flags.
  </verify>
  <done>
    - `mac-cleaner --system-caches --dry-run` displays formatted table with category headers, entries sorted by size, and total
    - `mac-cleaner --system-caches` (without --dry-run) shows same output (no deletion in Phase 2)
    - `mac-cleaner --help` lists --system-caches and --dry-run flags with terse descriptions
    - `mac-cleaner` (no flags) still shows help text
    - Colors render in terminal, are disabled when piped
    - Sizes formatted as SI units (kB, MB, GB) matching macOS convention
  </done>
</task>

</tasks>

<verification>
```bash
# All tests pass
cd /Users/gregor/projects/mac-clarner && go test ./... -count=1

# Binary compiles
cd /Users/gregor/projects/mac-clarner && go build -o /tmp/mac-cleaner .

# End-to-end: scan shows output
/tmp/mac-cleaner --system-caches --dry-run

# End-to-end: no flags shows help
/tmp/mac-cleaner

# Verify --help lists new flags
/tmp/mac-cleaner --help | grep -E "(system-caches|dry-run)"

# Verify no files were modified (scan is read-only)
# Create a test file, scan, verify it still exists
touch /tmp/scan-test-marker && /tmp/mac-cleaner --system-caches && ls /tmp/scan-test-marker

# Clean up
rm /tmp/mac-cleaner /tmp/scan-test-marker
```

All commands succeed. Scan output shows categories with sizes. Help text shows new flags.
</verification>

<success_criteria>
- `mac-cleaner --system-caches --dry-run` produces formatted output showing cache directories and sizes
- Output includes User App Caches (~/Library/Caches), User Logs (~/Library/Logs), and QuickLook Thumbnails (if present)
- Total reclaimable space shown at bottom
- No files are deleted in any mode
- All existing tests still pass (safety layer, scan utilities)
- New scanner tests pass with temp directories
- `--help` shows both --system-caches and --dry-run flags
</success_criteria>

<output>
After completion, create `.planning/phases/02-system-cache-scanning/02-02-SUMMARY.md`
</output>
