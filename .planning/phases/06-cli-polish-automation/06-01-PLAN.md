---
phase: 06-cli-polish-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/scan/types.go
  - cmd/root.go
autonomous: true

must_haves:
  truths:
    - "mac-cleaner --all scans all four categories without entering interactive mode"
    - "mac-cleaner --all --dry-run --json produces valid JSON to stdout with no ANSI codes"
    - "mac-cleaner --all --dry-run --verbose shows file paths beneath each entry"
    - "JSON output contains categories array with category, description, entries, and total_size fields"
    - "JSON output entries contain path, description, and size (int64 bytes) fields"
  artifacts:
    - path: "internal/scan/types.go"
      provides: "JSON struct tags on ScanEntry, CategoryResult, ScanSummary"
      contains: "json:\"path\""
    - path: "cmd/root.go"
      provides: "--all, --json, --verbose flags, PreRun hook, printJSON function"
      contains: "flagAll"
  key_links:
    - from: "cmd/root.go"
      to: "internal/scan/types.go"
      via: "json.MarshalIndent on scan.ScanSummary"
      pattern: "json\\.NewEncoder.*ScanSummary|json\\.MarshalIndent.*ScanSummary"
    - from: "cmd/root.go PreRun"
      to: "cmd/root.go Run"
      via: "--all sets four scan booleans before Run checks them"
      pattern: "flagSystemCaches = true"
---

<objective>
Add --all, --json, and --verbose flags to mac-cleaner CLI.

Purpose: Enable automation workflows (--all --dry-run --json) and detailed inspection (--verbose) for power users and AI agents.
Output: Modified cmd/root.go with three new flags, PreRun hook, JSON output path, verbose print extension. Modified internal/scan/types.go with json struct tags.
</objective>

<execution_context>
@/Users/gregor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gregor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-polish-automation/06-RESEARCH.md
@cmd/root.go
@internal/scan/types.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JSON struct tags and wire --all, --json, --verbose flags</name>
  <files>internal/scan/types.go, cmd/root.go</files>
  <action>
**Step 1: Add JSON struct tags to internal/scan/types.go**

Add `json:` struct tags to all fields on all three types:

```go
type ScanEntry struct {
    Path        string `json:"path"`
    Description string `json:"description"`
    Size        int64  `json:"size"`
}

type CategoryResult struct {
    Category    string      `json:"category"`
    Description string      `json:"description"`
    Entries     []ScanEntry `json:"entries"`
    TotalSize   int64       `json:"total_size"`
}

type ScanSummary struct {
    Categories []CategoryResult `json:"categories"`
    TotalSize  int64            `json:"total_size"`
}
```

Keep existing doc comments unchanged. Only add the struct tags.

**Step 2: Register three new flags in cmd/root.go**

Add package-level bool vars:
```go
var (
    flagAll     bool
    flagJSON    bool
    flagVerbose bool
)
```

Register in init():
```go
rootCmd.Flags().BoolVar(&flagAll, "all", false, "scan all categories")
rootCmd.Flags().BoolVar(&flagJSON, "json", false, "output results as JSON")
rootCmd.Flags().BoolVar(&flagVerbose, "verbose", false, "show detailed file listing")
```

**Step 3: Add PreRun hook for --all expansion**

Set `rootCmd.PreRun` in init() (after flag registration):
```go
rootCmd.PreRun = func(cmd *cobra.Command, args []string) {
    if flagAll {
        flagSystemCaches = true
        flagBrowserData = true
        flagDevCaches = true
        flagAppLeftovers = true
    }
    if flagJSON {
        color.NoColor = true
    }
}
```

The `color.NoColor = true` line prevents ANSI escape codes from contaminating JSON output. This is critical -- without it, fatih/color emits color codes when stdout is a TTY, which breaks JSON parsing.

**Step 4: Add printJSON function**

Add import for `"encoding/json"`.

Create function:
```go
func printJSON(results []scan.CategoryResult) {
    var totalSize int64
    for _, cat := range results {
        totalSize += cat.TotalSize
    }
    summary := scan.ScanSummary{
        Categories: results,
        TotalSize:  totalSize,
    }
    enc := json.NewEncoder(os.Stdout)
    enc.SetIndent("", "  ")
    if err := enc.Encode(summary); err != nil {
        fmt.Fprintf(os.Stderr, "Error encoding JSON: %v\n", err)
        os.Exit(1)
    }
}
```

**Step 5: Wire JSON output into the Run function**

In the `ran` (flag-based) branch of Run, after all scan results are collected but BEFORE the deletion flow:

- If `flagJSON` is set, call `printJSON(allResults)` instead of individual `printResults` calls.
- The four `runXxxScan` functions currently call `printResults` internally. When `flagJSON` is set, suppress those calls by adding a guard: change each `runXxxScan` to skip `printResults` when `flagJSON` is true.

Modify each of the four `runXxxScan` functions to check `flagJSON`:
```go
func runSystemCachesScan(cmd *cobra.Command) []scan.CategoryResult {
    results, err := system.Scan()
    if err != nil {
        fmt.Fprintf(os.Stderr, "Error: %v\n", err)
        return nil
    }
    if !flagJSON {
        printResults(results, flagDryRun, "System Caches")
    }
    return results
}
```
Apply the same pattern to `runBrowserDataScan`, `runDevCachesScan`, `runAppLeftoversScan`.

In the `ran` branch, after collecting all results and before the deletion flow, add:
```go
if flagJSON {
    printJSON(allResults)
    if flagDryRun {
        return
    }
}
```

If `--json` is used without any scan flags (no `--all`, no specific flags), print an error and exit:
```go
if flagJSON && !ran {
    fmt.Fprintln(os.Stderr, "Error: --json requires --all or a scan flag (--system-caches, --browser-data, --dev-caches, --app-leftovers)")
    os.Exit(1)
}
```
Place this check right after the flag-based scanning block, before the `!ran` interactive mode block.

**Step 6: Add verbose path display to printResults**

In the `printResults` function, after each entry's description/size line in the tabwriter loop, add:
```go
if flagVerbose {
    path := shortenHome(entry.Path, home)
    fmt.Fprintf(w, "      %s\t\t\n", path)
}
```

This shows the shortened file path on the line below each entry when `--verbose` is active. The path is indented further (6 spaces) to visually nest under the entry description.

**Important notes:**
- `--json` and `--verbose` can both be set, but `--json` takes precedence (JSON always includes full data, so `--verbose` has no additional effect when `--json` is active).
- `--all` enters flag-based mode (sets `ran=true`), never interactive mode.
- The interactive mode path (`!ran`) is unchanged -- it does not support `--json` or `--verbose`.
  </action>
  <verify>
Run `go build ./...` -- should compile with no errors.

Run `go vet ./...` -- should pass.

Run `go test ./...` -- all existing tests should pass (struct tag additions and new flags don't break existing behavior).

Verify flag registration:
```bash
go run . --help | grep -E '(all|json|verbose)'
```
Should show all three flags in help output.

Verify `--all` dispatches to flag mode (not interactive):
```bash
go run . --all --dry-run 2>&1 | head -5
```
Should show scan results, not interactive prompts.

Verify `--json` output is valid JSON:
```bash
go run . --all --dry-run --json 2>/dev/null | python3 -m json.tool > /dev/null && echo "Valid JSON"
```

Verify `--verbose` shows paths:
```bash
go run . --system-caches --dry-run --verbose 2>&1 | grep '~/'
```
Should show file paths starting with `~/`.

Verify `--json` without scan flags errors:
```bash
go run . --json 2>&1 | grep "Error"
```
Should print error message.
  </verify>
  <done>
- `--all` flag scans all four categories in flag-based mode (not interactive)
- `--json` outputs valid, parseable JSON with categories, entries, sizes
- `--json` suppresses all human-readable output and ANSI color codes on stdout
- `--json` without scan flags prints error and exits
- `--verbose` shows file paths beneath each entry in human-readable output
- All existing tests pass
- JSON struct tags on ScanEntry, CategoryResult, and ScanSummary
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles successfully
2. `go test ./...` -- all tests pass
3. `go run . --all --dry-run` shows all four category scans
4. `go run . --all --dry-run --json | python3 -m json.tool` validates JSON
5. `go run . --all --dry-run --verbose` shows paths under each entry
6. `go run . --json` exits with error about missing scan flag
7. JSON output contains no ANSI escape codes (no `\033` sequences)
</verification>

<success_criteria>
- Three new flags (--all, --json, --verbose) appear in help text
- --all scans all categories in non-interactive mode
- --json produces valid JSON output to stdout
- --verbose shows file paths in human-readable output
- No regression in existing tests or behavior
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-polish-automation/06-01-SUMMARY.md`
</output>
