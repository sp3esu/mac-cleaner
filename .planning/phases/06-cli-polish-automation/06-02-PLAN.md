---
phase: 06-cli-polish-automation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - cmd/root.go
autonomous: true

must_haves:
  truths:
    - "mac-cleaner --all --skip-browser-data scans everything except browser data"
    - "mac-cleaner --all --skip-derived-data scans everything except Xcode DerivedData"
    - "mac-cleaner --all --force deletes without confirmation prompt"
    - "mac-cleaner --all --force --dry-run scans everything without prompt or deletion"
    - "Skip flags work in both --all mode and individual scan flag mode"
    - "All 4 category-level and 12 item-level skip flags are registered"
  artifacts:
    - path: "cmd/root.go"
      provides: "--skip-* flags (4 category + 12 item), --force flag, buildSkipSet, filterSkipped functions"
      contains: "flagSkipDerivedData"
  key_links:
    - from: "cmd/root.go PreRun"
      to: "cmd/root.go Run"
      via: "category skip flags negate scan booleans after --all expansion"
      pattern: "flagSkipSystemCaches.*flagSystemCaches = false"
    - from: "cmd/root.go buildSkipSet"
      to: "cmd/root.go filterSkipped"
      via: "skip map drives post-scan result filtering"
      pattern: "filterSkipped.*buildSkipSet"
    - from: "cmd/root.go --force"
      to: "confirm.PromptConfirmation"
      via: "--force bypasses confirmation call"
      pattern: "flagForce.*PromptConfirmation"
---

<objective>
Add --skip-* flags (category-level and item-level) and --force flag to mac-cleaner CLI.

Purpose: Enable granular exclusion of scan categories/items and automation-friendly confirmation bypass. Completes the CLI polish phase.
Output: Modified cmd/root.go with 16 skip flags, --force flag, skip filtering functions, and force bypass logic.
</objective>

<execution_context>
@/Users/gregor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gregor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-polish-automation/06-RESEARCH.md
@.planning/phases/06-cli-polish-automation/06-01-SUMMARY.md
@cmd/root.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --skip-* category flags, --skip-* item flags, and --force flag</name>
  <files>cmd/root.go</files>
  <action>
**Step 1: Register --force and 4 category-level skip flags**

Add package-level bool vars:
```go
var (
    flagForce            bool
    flagSkipSystemCaches bool
    flagSkipBrowserData  bool
    flagSkipDevCaches    bool
    flagSkipAppLeftovers bool
)
```

Register in init():
```go
rootCmd.Flags().BoolVar(&flagForce, "force", false, "bypass confirmation prompt (for automation)")
rootCmd.Flags().BoolVar(&flagSkipSystemCaches, "skip-system-caches", false, "skip system cache scanning")
rootCmd.Flags().BoolVar(&flagSkipBrowserData, "skip-browser-data", false, "skip browser data scanning")
rootCmd.Flags().BoolVar(&flagSkipDevCaches, "skip-dev-caches", false, "skip developer cache scanning")
rootCmd.Flags().BoolVar(&flagSkipAppLeftovers, "skip-app-leftovers", false, "skip app leftover scanning")
```

**Step 2: Register 12 item-level skip flags**

Add package-level bool vars:
```go
var (
    flagSkipDerivedData   bool
    flagSkipNpm           bool
    flagSkipYarn          bool
    flagSkipHomebrew      bool
    flagSkipDocker        bool
    flagSkipSafari        bool
    flagSkipChrome        bool
    flagSkipFirefox       bool
    flagSkipQuicklook     bool
    flagSkipOrphanedPrefs bool
    flagSkipIosBackups    bool
    flagSkipOldDownloads  bool
)
```

Register in init():
```go
rootCmd.Flags().BoolVar(&flagSkipDerivedData, "skip-derived-data", false, "skip Xcode DerivedData")
rootCmd.Flags().BoolVar(&flagSkipNpm, "skip-npm", false, "skip npm cache")
rootCmd.Flags().BoolVar(&flagSkipYarn, "skip-yarn", false, "skip Yarn cache")
rootCmd.Flags().BoolVar(&flagSkipHomebrew, "skip-homebrew", false, "skip Homebrew cache")
rootCmd.Flags().BoolVar(&flagSkipDocker, "skip-docker", false, "skip Docker reclaimable space")
rootCmd.Flags().BoolVar(&flagSkipSafari, "skip-safari", false, "skip Safari cache")
rootCmd.Flags().BoolVar(&flagSkipChrome, "skip-chrome", false, "skip Chrome cache")
rootCmd.Flags().BoolVar(&flagSkipFirefox, "skip-firefox", false, "skip Firefox cache")
rootCmd.Flags().BoolVar(&flagSkipQuicklook, "skip-quicklook", false, "skip QuickLook thumbnails")
rootCmd.Flags().BoolVar(&flagSkipOrphanedPrefs, "skip-orphaned-prefs", false, "skip orphaned preferences")
rootCmd.Flags().BoolVar(&flagSkipIosBackups, "skip-ios-backups", false, "skip iOS device backups")
rootCmd.Flags().BoolVar(&flagSkipOldDownloads, "skip-old-downloads", false, "skip old Downloads files")
```

**Step 3: Extend PreRun hook with category-level skip overrides**

After the existing `--all` expansion in PreRun, add category-level skip application:
```go
// Apply category-level skip overrides (after --all expansion)
if flagSkipSystemCaches { flagSystemCaches = false }
if flagSkipBrowserData  { flagBrowserData = false }
if flagSkipDevCaches    { flagDevCaches = false }
if flagSkipAppLeftovers { flagAppLeftovers = false }
```

This runs after `--all` sets all four flags to true, so `--all --skip-browser-data` correctly skips browser scanning.

**Step 4: Create buildSkipSet and filterSkipped functions**

Use data-driven approach per research recommendation:

```go
// buildSkipSet collects category IDs that should be excluded from results.
func buildSkipSet() map[string]bool {
    type skipMapping struct {
        flag       *bool
        categoryID string
    }
    mappings := []skipMapping{
        {&flagSkipDerivedData, "dev-xcode"},
        {&flagSkipNpm, "dev-npm"},
        {&flagSkipYarn, "dev-yarn"},
        {&flagSkipHomebrew, "dev-homebrew"},
        {&flagSkipDocker, "dev-docker"},
        {&flagSkipSafari, "browser-safari"},
        {&flagSkipChrome, "browser-chrome"},
        {&flagSkipFirefox, "browser-firefox"},
        {&flagSkipQuicklook, "quicklook"},
        {&flagSkipOrphanedPrefs, "app-orphaned-prefs"},
        {&flagSkipIosBackups, "app-ios-backups"},
        {&flagSkipOldDownloads, "app-old-downloads"},
    }
    skip := map[string]bool{}
    for _, m := range mappings {
        if *m.flag {
            skip[m.categoryID] = true
        }
    }
    return skip
}

// filterSkipped removes categories matching the skip set.
func filterSkipped(results []scan.CategoryResult, skip map[string]bool) []scan.CategoryResult {
    if len(skip) == 0 {
        return results
    }
    var filtered []scan.CategoryResult
    for _, cat := range results {
        if !skip[cat.Category] {
            filtered = append(filtered, cat)
        }
    }
    return filtered
}
```

**Step 5: Wire item-level skip filtering into the Run function**

In the flag-based (`ran`) branch, after all scan results are collected and BEFORE JSON output or deletion flow, apply item-level filtering:

```go
// Apply item-level skip filtering
skipSet := buildSkipSet()
allResults = filterSkipped(allResults, skipSet)
```

Place this BEFORE the `flagJSON` check and the deletion flow. This way, filtered results are used for both JSON output and deletion.

Also apply filtering in the interactive mode branch. In the `!ran` block, after `scanAll()` returns `allResults`, apply:
```go
allResults = filterSkipped(allResults, buildSkipSet())
```

This ensures skip-item flags work in interactive mode too (skipped items never appear in walkthrough).

**Step 6: Wire --force into the deletion flow**

In the flag-based (`ran`) branch, modify the deletion flow:

```go
if !flagDryRun && len(allResults) > 0 {
    if !flagForce {
        if !confirm.PromptConfirmation(os.Stdin, os.Stdout, allResults) {
            fmt.Println("Aborted.")
            return
        }
    }
    result := cleanup.Execute(allResults)
    printCleanupSummary(result)
}
```

The change is wrapping `PromptConfirmation` in `if !flagForce`. When `--force` is set, confirmation is skipped and deletion proceeds directly.

In the interactive mode branch (`!ran`), `--force` skips the final confirmation after the walkthrough (since the user already made per-item choices):

```go
if !flagForce {
    if !confirm.PromptConfirmation(reader, os.Stdout, marked) {
        fmt.Println("Aborted.")
        return
    }
}
```

**Important notes:**
- Category-level skip flags prevent scanners from running entirely (they negate the scan boolean in PreRun). This is more efficient than scanning and then filtering.
- Item-level skip flags filter results after scanning. This is simpler and doesn't require changing scanner APIs.
- `--force` only bypasses the confirmation prompt. It does NOT bypass the safety layer (IsPathBlocked still runs at deletion time inside cleanup.Execute).
- `system-caches` and `system-logs` don't have dedicated item-level skip flags -- they are covered by the category-level `--skip-system-caches`. This matches the research recommendation.
  </action>
  <verify>
Run `go build ./...` -- should compile with no errors.

Run `go vet ./...` -- should pass.

Run `go test ./...` -- all existing tests should pass.

Verify skip-category flags in help:
```bash
go run . --help | grep 'skip-'
```
Should show all 16 skip flags.

Verify --force in help:
```bash
go run . --help | grep 'force'
```

Verify `--all --skip-browser-data` excludes browser results:
```bash
go run . --all --skip-browser-data --dry-run 2>&1 | grep -i "browser"
```
Should produce no browser output.

Verify `--skip-derived-data` excludes Xcode results:
```bash
go run . --dev-caches --skip-derived-data --dry-run 2>&1 | grep -i "derived\|xcode"
```
Should produce no Xcode output.

Verify `--all --force --dry-run` produces output without prompting:
```bash
echo "" | timeout 5 go run . --all --force --dry-run 2>&1
```
Should produce scan output and exit without waiting for input.
  </verify>
  <done>
- 4 category-level skip flags (--skip-system-caches, --skip-browser-data, --skip-dev-caches, --skip-app-leftovers) prevent scanner execution
- 12 item-level skip flags filter specific categories from results
- --skip-derived-data correctly filters out dev-xcode category
- --force bypasses confirmation prompt in both flag-based and interactive modes
- --force does not bypass safety layer (IsPathBlocked still enforced)
- --all --skip-browser-data correctly scans everything except browser data
- Skip flags work in both flag-based and interactive modes
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles successfully
2. `go test ./...` -- all tests pass
3. `go run . --help` shows --force and 16 --skip-* flags
4. `go run . --all --skip-browser-data --dry-run` excludes browser results
5. `go run . --all --skip-derived-data --dry-run` excludes Xcode DerivedData
6. `go run . --all --force --dry-run` runs without prompting
7. `go run . --all --skip-browser-data --skip-derived-data --dry-run --json | python3 -m json.tool` produces valid JSON without browser or Xcode categories
</verification>

<success_criteria>
- 16 skip flags registered and functional (4 category + 12 item)
- --force bypasses confirmation in flag-based mode
- Skip flags compose correctly with --all (--all --skip-X scans everything except X)
- Item-level skips filter results after scanning
- No regression in existing tests or behavior
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-polish-automation/06-02-SUMMARY.md`
</output>
