---
phase: 07-safety-enforcement
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - cmd/root.go
  - internal/confirm/confirm.go
  - internal/interactive/interactive.go
autonomous: true

must_haves:
  truths:
    - "Risky items display a red [risky] tag and moderate items display a yellow [moderate] tag in scan output"
    - "Safe items display with no risk tag (clean default output)"
    - "Confirmation prompt shows a WARNING line when risky items are in the removal set"
    - "Interactive walkthrough shows risk level tag next to each item"
    - "Permission issues are reported to stderr after scanning completes"
    - "JSON output includes risk_level on every entry and permission_issues on summary"
    - "Permission issues in JSON mode are NOT printed to stderr (included in JSON only)"
  artifacts:
    - path: "cmd/root.go"
      provides: "Risk-colored printResults, printPermissionIssues, updated printJSON with permission aggregation"
      contains: "printPermissionIssues"
    - path: "internal/confirm/confirm.go"
      provides: "Risky item warning before confirmation prompt"
      contains: "WARNING"
    - path: "internal/interactive/interactive.go"
      provides: "Risk level tag in walkthrough item display"
      contains: "RiskLevel"
  key_links:
    - from: "cmd/root.go"
      to: "internal/safety/risk.go"
      via: "import for risk level constants (RiskRisky, RiskModerate)"
      pattern: "safety\\.RiskRisky|safety\\.RiskModerate"
    - from: "internal/confirm/confirm.go"
      to: "internal/safety/risk.go"
      via: "import for risk constant in warning check"
      pattern: "safety\\.RiskRisky"
    - from: "cmd/root.go printJSON"
      to: "scan.ScanSummary.PermissionIssues"
      via: "aggregates permission issues from all categories into summary"
      pattern: "PermissionIssues"
---

<objective>
Add risk-aware display, risky item warnings, and permission issue reporting to the CLI output layer.

Purpose: Users need to see which items are risky before deciding to delete them. The confirmation prompt needs to warn about risky items. Permission issues need to be reported so users know what was skipped. This plan wires the risk metadata from Plan 01 into all output paths: human-readable, JSON, interactive walkthrough, and confirmation.

Output: Risk tags appear in scan output, warnings appear in confirmation, permission issues reported after scan. JSON output includes risk_level and permission_issues fields.
</objective>

<execution_context>
@/Users/gregor/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gregor/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-safety-enforcement/07-RESEARCH.md
@.planning/phases/07-safety-enforcement/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Risk-colored display and permission reporting in CLI</name>
  <files>
    cmd/root.go
  </files>
  <action>
**cmd/root.go** -- Add import `"github.com/gregor/mac-cleaner/internal/safety"`.

**1. Modify `printResults` to show risk tags:**

In the entry loop inside `printResults`, after computing `sizeStr`, determine the risk tag:
```go
riskTag := ""
switch entry.RiskLevel {
case safety.RiskRisky:
    riskTag = color.New(color.FgRed).Sprint("  [risky]")
case safety.RiskModerate:
    riskTag = color.New(color.FgYellow).Sprint("  [moderate]")
// safe: no tag for clean output
}
```
Then include `riskTag` in the tabwriter format string:
```go
fmt.Fprintf(w, "    %s%s\t  %s\t\n", entry.Description, riskTag, cyan.Sprint(sizeStr))
```
Note: create the red and yellow color instances outside the loop for efficiency (alongside the existing `bold`, `cyan`, `greenBold` at the top of printResults).

**2. Add `printPermissionIssues` function:**

New function that collects PermissionIssues from all CategoryResults and prints them to stderr:
```go
func printPermissionIssues(results []scan.CategoryResult) {
    var issues []scan.PermissionIssue
    for _, cat := range results {
        issues = append(issues, cat.PermissionIssues...)
    }
    if len(issues) == 0 {
        return
    }
    home, _ := os.UserHomeDir()
    yellow := color.New(color.FgYellow)
    fmt.Fprintln(os.Stderr)
    yellow.Fprintf(os.Stderr, "Note: %d path(s) could not be accessed (permission denied):\n", len(issues))
    for _, issue := range issues {
        path := shortenHome(issue.Path, home)
        fmt.Fprintf(os.Stderr, "  %s â€” %s\n", path, issue.Description)
    }
}
```

**3. Call `printPermissionIssues` after scanning:**

In the `Run` function, after all scan runners have executed and before the deletion flow:
- In the flag-based path (when `ran == true`): call `printPermissionIssues(allResults)` after filterSkipped but before the JSON/deletion section. Only call if `!flagJSON` (JSON mode includes permission issues in the JSON output instead).
- In the interactive path (when `ran == false`): call `printPermissionIssues(allResults)` after scanAll() and before the walkthrough. Only call if not in JSON mode.

**4. Update `printJSON` to aggregate permission issues:**

In `printJSON`, collect PermissionIssues from all categories into the ScanSummary:
```go
var permIssues []scan.PermissionIssue
for _, cat := range results {
    permIssues = append(permIssues, cat.PermissionIssues...)
}
summary := scan.ScanSummary{
    Categories:       results,
    TotalSize:        totalSize,
    PermissionIssues: permIssues,
}
```

**5. Filter out empty categories that only have permission issues from display paths:**

Categories with zero entries but permission issues should NOT appear in `printResults` output (they have nothing to display). But their permission issues still feed into `printPermissionIssues`. Add a guard at the top of the category loop in `printResults`:
```go
for _, cat := range results {
    if len(cat.Entries) == 0 {
        continue
    }
    // ... existing display code
}
```
Also update the `grandTotal` to only count categories with entries.

Run `go build ./...` to verify compilation.
  </action>
  <verify>
`go build ./...` succeeds.
`grep -n "printPermissionIssues" cmd/root.go` shows function definition and call sites.
`grep -n "RiskRisky\|RiskModerate\|risky\|moderate" cmd/root.go` shows risk tag logic in printResults.
`grep -n "PermissionIssues" cmd/root.go` shows aggregation in printJSON.
  </verify>
  <done>
printResults shows colored [risky]/[moderate] tags. printPermissionIssues reports skipped paths to stderr. printJSON includes aggregated permission_issues. Empty categories (permission-only) skipped in human display.
  </done>
</task>

<task type="auto">
  <name>Task 2: Risk warnings in confirmation and interactive walkthrough</name>
  <files>
    internal/confirm/confirm.go
    internal/interactive/interactive.go
  </files>
  <action>
**internal/confirm/confirm.go** -- Add import `"github.com/gregor/mac-cleaner/internal/safety"`.

Add a `hasRiskyItems` helper function:
```go
func hasRiskyItems(results []scan.CategoryResult) bool {
    for _, cat := range results {
        for _, entry := range cat.Entries {
            if entry.RiskLevel == safety.RiskRisky {
                return true
            }
        }
    }
    return false
}
```

In `PromptConfirmation`, after printing the total size line but BEFORE the "Type 'yes' to proceed:" prompt, add:
```go
if hasRiskyItems(results) {
    red := color.New(color.FgRed, color.Bold)
    red.Fprintln(out, "\nWARNING: Selection includes risky items that may be difficult or impossible to recover.")
}
```

Also add risk tags to the per-entry display in the confirmation listing. After `path := shortenHome(entry.Path, home)`:
```go
riskTag := ""
switch entry.RiskLevel {
case safety.RiskRisky:
    riskTag = color.New(color.FgRed).Sprint(" [risky]")
case safety.RiskModerate:
    riskTag = color.New(color.FgYellow).Sprint(" [moderate]")
}
fmt.Fprintf(out, "    %s%s  (%s)\n", path, riskTag, scan.FormatSize(entry.Size))
```

**internal/interactive/interactive.go** -- Add import `"github.com/gregor/mac-cleaner/internal/safety"`.

In `RunWalkthrough`, in the per-entry display line, add risk tag. Change:
```go
fmt.Fprintf(out, "  [%d/%d] %s  %s\n", itemNum, totalItems,
    entry.Description, cyan.Sprint(sizeStr))
```
to:
```go
riskTag := ""
switch entry.RiskLevel {
case safety.RiskRisky:
    riskTag = color.New(color.FgRed).Sprint("  [risky]")
case safety.RiskModerate:
    riskTag = color.New(color.FgYellow).Sprint("  [moderate]")
}
fmt.Fprintf(out, "  [%d/%d] %s  %s%s\n", itemNum, totalItems,
    entry.Description, cyan.Sprint(sizeStr), riskTag)
```

Create the color instances at the top of RunWalkthrough (outside the loops) for efficiency.

Run `go build ./...` and `go test ./...`.
  </action>
  <verify>
`go build ./...` succeeds.
`go test ./...` passes all tests.
`grep -n "WARNING.*risky" internal/confirm/confirm.go` shows warning line.
`grep -n "RiskLevel\|risky\|moderate" internal/interactive/interactive.go` shows risk tag in walkthrough.
`grep -n "hasRiskyItems" internal/confirm/confirm.go` shows helper function.
  </verify>
  <done>
Confirmation prompt shows WARNING when risky items present. Per-entry display in confirmation shows [risky]/[moderate] tags with colors. Interactive walkthrough shows risk level tag next to each item. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors.
2. `go test ./...` passes all tests.
3. Run `mac-cleaner --system-caches --dry-run` and verify no [risky]/[moderate] tags appear (system caches are safe).
4. Run `mac-cleaner --dev-caches --dry-run` and verify [risky] appears for Xcode DerivedData, [moderate] for npm/yarn/Homebrew.
5. Run `mac-cleaner --all --json --dry-run` and verify JSON output contains `"risk_level"` on entries and `"permission_issues"` on summary.
6. Verify no ad-hoc Safari TCC stderr messages remain (replaced by structured PermissionIssue reporting).
</verification>

<success_criteria>
- Risky items show red [risky] tag in scan output, confirmation listing, and interactive walkthrough
- Moderate items show yellow [moderate] tag in same locations
- Safe items show no risk tag (clean output)
- Confirmation prompt includes bold red WARNING line when risky items are present
- Permission issues displayed to stderr after scanning (not in JSON mode)
- JSON output includes risk_level on all entries and permission_issues array on ScanSummary
- All existing and new tests pass
- Tool never prompts for Full Disk Access
</success_criteria>

<output>
After completion, create `.planning/phases/07-safety-enforcement/07-02-SUMMARY.md`
</output>
